name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test-core:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: 1.8.0
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies using setup script
      run: |
        # Use our standardized setup script for CI
        bash scripts/setup/setup.sh
        
    - name: Verify installation
      run: |
        poetry run python -c "
        import torch, numpy, transformers, faiss
        print(f'PyTorch: {torch.__version__}')
        print(f'NumPy: {numpy.__version__}')
        print(f'Transformers: {transformers.__version__}')
        print(f'FAISS: {faiss.__version__}')
        print('âœ… All dependencies installed successfully')
        "

    - name: Set PYTHONPATH and environment
      run: |
        echo "PYTHONPATH=$PYTHONPATH:$(pwd)/src" >> $GITHUB_ENV
        echo "INSIGHTSPIKE_LITE_MODE=1" >> $GITHUB_ENV

    - name: Test core functionality (no heavy dependencies)
      run: |
        # Test specific unit tests that don't require heavy dependencies
        poetry run pytest development/tests/unit/test_config.py -v --tb=short
        poetry run pytest development/tests/unit/test_cache_manager.py -v --tb=short
        poetry run pytest development/tests/unit/test_cli.py -v --tb=short
        poetry run pytest development/tests/unit/test_data_loader.py -v --tb=short
        poetry run pytest development/tests/unit/test_layer1_error_monitor.py -v --tb=short
        poetry run pytest development/tests/unit/test_layer2_memory_manager.py -v --tb=short
        poetry run pytest development/tests/unit/test_utils.py -v --tb=short

  test-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: 1.8.0
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Install dependencies using setup script
      run: |
        # Use our standardized setup script for CI integration tests
        bash scripts/setup/setup.sh

    - name: Set PYTHONPATH and environment
      run: |
        echo "PYTHONPATH=$PYTHONPATH:$(pwd)/src" >> $GITHUB_ENV
        echo "INSIGHTSPIKE_LITE_MODE=1" >> $GITHUB_ENV

    - name: Ensure sample data exists
      run: |
        mkdir -p data/raw
        echo "The aurora borealis is caused by charged particles from the sun interacting with Earth's magnetic field." > data/raw/test_sentences.txt
        echo "Quantum entanglement is a phenomenon where particles become correlated in ways that defy classical physics." >> data/raw/test_sentences.txt
        echo "Artificial intelligence uses machine learning algorithms to process data and make predictions." >> data/raw/test_sentences.txt
        echo "The human brain contains billions of neurons that communicate through synapses." >> data/raw/test_sentences.txt
        echo "Photosynthesis converts sunlight into chemical energy in plants." >> data/raw/test_sentences.txt
        echo "DNA contains the genetic instructions for all living organisms." >> data/raw/test_sentences.txt
        echo "Gravity is a fundamental force that attracts objects with mass toward each other." >> data/raw/test_sentences.txt
        echo "Evolution explains how species change over time through natural selection." >> data/raw/test_sentences.txt

    - name: Test with mocked dependencies
      run: |
        # Test with mocked PyTorch/transformers for integration testing
        poetry run pytest development/tests/unit/ -v --tb=short

    - name: Generate minimal faiss index
      run: |
        poetry run python scripts/production/create_minimal_index.py

    - name: Run system validation script
      run: |
        poetry run python scripts/production/system_validation.py || exit 1

    - name: Run PoC simple script
      run: |
        poetry run python scripts/run_poc_simple.py || exit 1

  lint-and-format:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: 1.8.0
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Install dev dependencies with Poetry
      run: |
        poetry install --with dev

    - name: Check code formatting
      run: |
        poetry run black --check src/ development/tests/ || echo "Run 'poetry run black src/ development/tests/' to fix formatting"
        poetry run isort --check-only src/ development/tests/ || echo "Run 'poetry run isort src/ development/tests/' to fix imports"

    - name: Lint code
      run: |
        poetry run flake8 src/ development/tests/ --max-line-length=100 --ignore=E203,W503 || echo "Fix linting issues"
