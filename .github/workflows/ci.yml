name: CI

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  test-core:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Cache pip
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/pyproject.toml') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install minimal dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pytest numpy

    - name: Set PYTHONPATH
      run: echo "PYTHONPATH=$PYTHONPATH:$(pwd)/src" >> $GITHUB_ENV

    - name: Test core functionality (no heavy dependencies)
      run: |
        # Test all unit tests in the directory (auto-discover)
        python -m pytest development/tests/unit/ -v --tb=short

  test-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install Poetry
      run: |
        python -m pip install --upgrade pip
        pip install poetry

    - name: Install dependencies
      run: |
        poetry install

    - name: Set PYTHONPATH
      run: echo "PYTHONPATH=$PYTHONPATH:$(pwd)/src" >> $GITHUB_ENV

    - name: Ensure sample data exists
      run: |
        mkdir -p data/raw
        echo "The aurora borealis is caused by charged particles from the sun interacting with Earth's magnetic field." > data/raw/test_sentences.txt
        echo "Quantum entanglement is a phenomenon where particles become correlated in ways that defy classical physics." >> data/raw/test_sentences.txt
        echo "Artificial intelligence uses machine learning algorithms to process data and make predictions." >> data/raw/test_sentences.txt
        echo "The human brain contains billions of neurons that communicate through synapses." >> data/raw/test_sentences.txt
        echo "Photosynthesis converts sunlight into chemical energy in plants." >> data/raw/test_sentences.txt
        echo "DNA contains the genetic instructions for all living organisms." >> data/raw/test_sentences.txt
        echo "Gravity is a fundamental force that attracts objects with mass toward each other." >> data/raw/test_sentences.txt
        echo "Evolution explains how species change over time through natural selection." >> data/raw/test_sentences.txt

    - name: Test with mocked dependencies
      run: |
        # Test with mocked PyTorch/transformers for integration testing
        poetry run python -m pytest development/tests/unit/ -v --tb=short

    - name: Run system validation script
      run: |
        poetry run python scripts/production/system_validation.py || exit 1

    - name: Run PoC simple script
      run: |
        poetry run python scripts/run_poc_simple.py || exit 1

  lint-and-format:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort

    - name: Check code formatting
      run: |
        black --check src/ tests/ || echo "Run 'black src/ tests/' to fix formatting"
        isort --check-only src/ tests/ || echo "Run 'isort src/ tests/' to fix imports"

    - name: Lint code
      run: |
        flake8 src/ tests/ --max-line-length=100 --ignore=E203,W503 || echo "Fix linting issues"
