name: Enhanced CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run daily at 2 AM UTC for dependency checks
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: "3.11.12"
  POETRY_VERSION: "2.1.3"

jobs:
  # Job 1: Code Quality and Linting
  code-quality:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Poetry
      uses: snok/install-poetry@v1.4.1
      with:
        version: ${{ env.POETRY_VERSION }}
        virtualenvs-create: true
        virtualenvs-in-project: true
        installer-parallel: true
    
    - name: Configure Poetry (match local environment)
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true
        poetry config installer.parallel true
        poetry config installer.re-resolve true
        poetry config solver.lazy-wheel true
        echo "Poetry configuration completed (matching local environment)"
    
    - name: Install CI dependencies
      run: |
        # Install minimal dependencies for CI (avoid faiss-gpu issues)
        export INSIGHTSPIKE_LITE_MODE=1
        python -m pip install --upgrade pip
        pip install pytest pytest-cov black isort flake8 mypy bandit
        pip install typer rich click
        pip install numpy==1.26.4 scipy scikit-learn networkx pyyaml
        pip install faiss-cpu==1.7.4  # Force CPU version for CI
        pip install torch --index-url https://download.pytorch.org/whl/cpu
        pip install -e . --no-deps  # Install project without dependencies
        echo "âœ… CI dependencies installed"
    
    - name: Run code formatting check
      run: |
        echo "ðŸ” Checking code formatting with black..."
        poetry run black --check src/ --diff || (echo "âŒ Code formatting issues found" && exit 1)
        echo "âœ… Code formatting check passed"
    
    - name: Run import sorting check
      run: |
        echo "ðŸ” Checking import sorting with isort..."
        poetry run isort --check-only src/ --diff || (echo "âŒ Import sorting issues found" && exit 1)
        echo "âœ… Import sorting check passed"
    
    - name: Run type checking
      run: |
        echo "ðŸ” Running type checking with mypy..."
        poetry run mypy src/insightspike --ignore-missing-imports || echo "âš ï¸ Type checking completed with warnings"
        echo "âœ… Type checking completed"
    
    - name: Run security scanning
      run: |
        echo "ðŸ” Running security scan with bandit..."
        poetry run bandit -r src/ -f json -o security-report.json || true
        echo "âœ… Security scan completed"
    
    - name: Upload security report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-report
        path: security-report.json

  # Job 2: Unit and Integration Tests
  test-suite:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      matrix:
        test-type: [unit, integration, mvp]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Poetry
      uses: snok/install-poetry@v1.4.1
      with:
        version: ${{ env.POETRY_VERSION }}
        virtualenvs-create: true
        virtualenvs-in-project: true
        installer-parallel: true
    
    - name: Configure Poetry (match local environment)
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true
        poetry config installer.parallel true
        poetry config installer.re-resolve true
        poetry config solver.lazy-wheel true
        echo "Poetry configuration completed (matching local environment)"
    
    - name: Cache Poetry dependencies
      uses: actions/cache@v4
      with:
        path: .venv
        key: poetry-${{ runner.os }}-${{ env.PYTHON_VERSION }}-${{ hashFiles('poetry.lock') }}
        restore-keys: |
          poetry-${{ runner.os }}-${{ env.PYTHON_VERSION }}-
    
    - name: Install dependencies with Poetry (CI - CPU only)
      run: |
        # Use Poetry but force CPU versions for CI
        export INSIGHTSPIKE_LITE_MODE=1
        # Install base project dependencies with Poetry
        poetry install --only main
        # Override GPU packages with CPU versions
        poetry run pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
        poetry run pip install faiss-cpu==1.7.4 --force-reinstall
        # Install dev dependencies for testing
        poetry run pip install pytest pytest-cov black isort flake8 mypy bandit
        echo "âœ… CI environment: Poetry + CPU-only dependencies"
    
    - name: Set environment variables
      run: |
        echo "PYTHONPATH=$PYTHONPATH:$(pwd)/src" >> $GITHUB_ENV
        echo "INSIGHTSPIKE_LITE_MODE=1" >> $GITHUB_ENV
        echo "CI_ENVIRONMENT=true" >> $GITHUB_ENV
    
    - name: Create test data
      run: |
        mkdir -p data/raw data/processed logs
        echo "Test data for integration tests" > data/raw/test_sentences.txt
        echo "Advanced test content for comprehensive analysis" > data/raw/integration_test.txt
    
    - name: Verify pytest installation
      run: |
        echo "ðŸ§ª Verifying pytest installation..."
        poetry run pytest --version
        poetry run python -c "import pytest; print(f'pytest version: {pytest.__version__}')"
    
    - name: Run Unit Tests
      if: matrix.test-type == 'unit'
      run: |
        echo "ðŸ§ª Running unit tests..."
        poetry run pytest tests/unit/ -v --tb=short --cov=src/insightspike --cov-report=xml
        echo "âœ… Unit tests completed"
    
    - name: Run Integration Tests  
      if: matrix.test-type == 'integration'
      run: |
        echo "ðŸ§ª Running integration tests (CPU-only)..."
        poetry run pytest tests/integration/ -v --tb=short -k "not gpu and not cuda"
        echo "âœ… Integration tests completed"
    
    - name: Run MVP Integration Tests
      if: matrix.test-type == 'mvp'
      run: |
        echo "ðŸ§ª Running MVP integration tests..."
        poetry run pytest tests/test_mvp_integration.py -v --tb=short -k "not gpu"
        echo "âœ… MVP integration tests completed"
    
    - name: Upload test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results-${{ matrix.test-type }}
        path: |
          coverage.xml
          .coverage
          pytest-report.xml

  # Job 3: Poetry CLI Resolution Validation
  poetry-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Poetry
      uses: snok/install-poetry@v1.4.1
      with:
        version: ${{ env.POETRY_VERSION }}
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Configure Poetry (match local environment)
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true
        poetry config installer.parallel true
        poetry config installer.re-resolve true
        poetry config solver.lazy-wheel true
        echo "Poetry configuration completed (matching local environment)"
    
    - name: Install dependencies
      run: |
        export INSIGHTSPIKE_LITE_MODE=1
        poetry install --only main
        poetry run pip install faiss-cpu==1.7.4 torch --index-url https://download.pytorch.org/whl/cpu
        echo "âœ… Poetry validation dependencies installed"
    
    - name: Run Poetry CLI Resolution Validation
      run: |
        echo "ðŸ”¬ Running comprehensive Poetry CLI validation..."
        poetry run python scripts/colab/validate_poetry_resolution.py --project-root .
        echo "âœ… Poetry CLI validation completed"
    
    - name: Test Colab Setup Scripts
      run: |
        echo "ðŸ§ª Testing Colab setup scripts..."
        chmod +x scripts/colab/setup_colab.sh
        # Test script syntax without full execution
        bash -n scripts/colab/setup_colab.sh
        echo "âœ… Colab setup scripts validated"

  # Job 4: Template and Documentation Validation
  template-validation:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Poetry
      uses: snok/install-poetry@v1.4.1
      with:
        version: ${{ env.POETRY_VERSION }}
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Configure Poetry (match local environment)
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true
        poetry config installer.parallel true
        poetry config installer.re-resolve true
        poetry config solver.lazy-wheel true
        echo "Poetry configuration completed (matching local environment)"
    
    - name: Install dependencies
      run: |
        export INSIGHTSPIKE_LITE_MODE=1
        poetry install --only main
        poetry run pip install faiss-cpu==1.7.4 torch --index-url https://download.pytorch.org/whl/cpu
        echo "âœ… Template validation dependencies installed"
    
    - name: Validate Production Templates
      run: |
        echo "ðŸŽ¯ Validating production integration templates..."
        poetry run python templates/production_integration_template.py --list
        poetry run python templates/production_integration_template.py --output /tmp/template_test/
        echo "âœ… Production templates validated"
    
    - name: Test Monitoring System
      run: |
        echo "ðŸ“Š Testing production monitoring system..."
        poetry run python monitoring/production_monitor.py --status
        echo "âœ… Monitoring system validated"
    
    - name: Validate Documentation
      run: |
        echo "ðŸ“š Validating documentation..."
        # Check for required documentation files
        test -f docs/COLAB_INTEGRATION_IMPROVEMENTS.md
        test -f README.md
        test -f CONTRIBUTING.md
        echo "âœ… Documentation structure validated"

  # Job 5: Performance Benchmarking
  performance-benchmark:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Poetry
      uses: snok/install-poetry@v1.4.1
      with:
        version: ${{ env.POETRY_VERSION }}
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Configure Poetry (match local environment)
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true
        poetry config installer.parallel true
        poetry config installer.re-resolve true
        poetry config solver.lazy-wheel true
        echo "Poetry configuration completed (matching local environment)"
    
    - name: Install dependencies
      run: |
        export INSIGHTSPIKE_LITE_MODE=1
        poetry install --only main
        poetry run pip install faiss-cpu==1.7.4 torch --index-url https://download.pytorch.org/whl/cpu
        echo "âœ… Performance benchmark dependencies installed"
    
    - name: Run Performance Benchmarks
      run: |
        echo "âš¡ Running performance benchmarks..."
        export INSIGHTSPIKE_LITE_MODE=1
        poetry run python benchmarks/performance_suite.py --quick --ci-mode
        echo "âœ… Performance benchmarks completed"
    
    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: benchmark-results
        path: |
          benchmarks/results/
          logs/performance_*.log

  # Job 6: Dependency Security and License Check
  dependency-security:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Poetry
      uses: snok/install-poetry@v1.4.1
      with:
        version: ${{ env.POETRY_VERSION }}
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Configure Poetry (match local environment)
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true
        poetry config installer.parallel true
        poetry config installer.re-resolve true
        poetry config solver.lazy-wheel true
        echo "Poetry configuration completed (matching local environment)"
    
    - name: Install dependencies
      run: |
        export INSIGHTSPIKE_LITE_MODE=1
        poetry install --only main
        poetry run pip install safety pip-licenses
        echo "âœ… Security check dependencies installed"
    
    - name: Run dependency vulnerability scan
      run: |
        echo "ðŸ” Scanning dependencies for vulnerabilities..."
        poetry run safety check --json --output safety-report.json || true
        echo "âœ… Dependency vulnerability scan completed"
    
    - name: Check license compatibility
      run: |
        echo "ðŸ“„ Checking license compatibility..."
        poetry run pip-licenses --format=json --output-file=licenses.json
        echo "âœ… License check completed"
    
    - name: Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: dependency-security
        path: |
          safety-report.json
          licenses.json

  # Job 7: Integration with Monitoring
  monitoring-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [test-suite, poetry-validation]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Poetry
      uses: snok/install-poetry@v1.4.1
      with:
        version: ${{ env.POETRY_VERSION }}
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Configure Poetry (match local environment)
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true
        poetry config installer.parallel true
        poetry config installer.re-resolve true
        poetry config solver.lazy-wheel true
        echo "Poetry configuration completed (matching local environment)"
    
    - name: Install dependencies
      run: |
        export INSIGHTSPIKE_LITE_MODE=1
        poetry install --only main
        poetry run pip install psutil requests faiss-cpu==1.7.4
        poetry run pip install torch --index-url https://download.pytorch.org/whl/cpu
        echo "âœ… Monitoring integration dependencies installed"
    
    - name: Test Monitoring System
      run: |
        echo "ðŸ“Š Testing production monitoring system..."
        mkdir -p logs
        poetry run python monitoring/production_monitor.py --duration 30 &
        MONITOR_PID=$!
        sleep 35
        kill $MONITOR_PID || true
        echo "âœ… Monitoring integration test completed"
    
    - name: Validate Monitoring Output
      run: |
        echo "ðŸ” Validating monitoring output..."
        test -f logs/production_monitor.log
        test -f logs/performance_metrics.jsonl
        echo "âœ… Monitoring output validated"

  # Job 8: Final Integration Report
  integration-report:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [code-quality, test-suite, poetry-validation, template-validation, performance-benchmark, dependency-security, monitoring-integration]
    if: always()
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: ci-artifacts
    
    - name: Generate Integration Report
      run: |
        echo "ðŸ“‹ Generating comprehensive CI/CD integration report..."
        
        cat > ci-integration-report.md << 'EOF'
        # InsightSpike-AI CI/CD Integration Report
        
        **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
        **Branch:** ${{ github.ref_name }}
        **Commit:** ${{ github.sha }}
        
        ## âœ… Pipeline Status
        
        | Job | Status | Duration |
        |-----|--------|----------|
        | Code Quality | ${{ needs.code-quality.result }} | - |
        | Test Suite | ${{ needs.test-suite.result }} | - |
        | Poetry Validation | ${{ needs.poetry-validation.result }} | - |
        | Template Validation | ${{ needs.template-validation.result }} | - |
        | Performance Benchmark | ${{ needs.performance-benchmark.result }} | - |
        | Dependency Security | ${{ needs.dependency-security.result }} | - |
        | Monitoring Integration | ${{ needs.monitoring-integration.result }} | - |
        
        ## ðŸ“Š Artifacts Generated
        
        $(find ci-artifacts -type f -name "*.json" -o -name "*.log" -o -name "*.xml" | wc -l) artifacts collected
        
        ## ðŸš€ Integration Improvements Validated
        
        - âœ… Poetry CLI Resolution (100% success rate target)
        - âœ… Colab Integration Templates
        - âœ… Production Monitoring System
        - âœ… Enhanced CI/CD Pipeline
        - âœ… Security and Performance Validation
        
        ## ðŸ“ˆ Next Steps
        
        1. Deploy to staging environment
        2. Run large-scale integration tests
        3. Monitor production performance
        4. Gather community feedback
        
        EOF
        
        echo "âœ… Integration report generated"
    
    - name: Upload Integration Report
      uses: actions/upload-artifact@v4
      with:
        name: ci-integration-report
        path: ci-integration-report.md
    
    - name: Post Integration Summary
      run: |
        echo "ðŸŽ¯ InsightSpike-AI Enhanced CI/CD Pipeline Summary"
        echo "================================================"
        echo "âœ… Code Quality: ${{ needs.code-quality.result }}"
        echo "âœ… Test Suite: ${{ needs.test-suite.result }}"
        echo "âœ… Poetry Validation: ${{ needs.poetry-validation.result }}"
        echo "âœ… Template Validation: ${{ needs.template-validation.result }}"
        echo "âœ… Performance Benchmark: ${{ needs.performance-benchmark.result }}"
        echo "âœ… Dependency Security: ${{ needs.dependency-security.result }}"
        echo "âœ… Monitoring Integration: ${{ needs.monitoring-integration.result }}"
        echo "================================================"
        echo "ðŸš€ Enhanced CI/CD pipeline validation complete!"
