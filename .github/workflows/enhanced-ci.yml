name: InsightSpike-AI Core CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: "3.11.12"
  POETRY_VERSION: "1.8.3"

jobs:
  # Core functionality tests - what users actually care about
  core-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Poetry
      uses: snok/install-poetry@v1.4.1
      with:
        version: ${{ env.POETRY_VERSION }}
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Configure Poetry
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true
        poetry config installer.parallel true
    
    - name: Install dependencies (FAISS-compatible)
      run: |
        export INSIGHTSPIKE_LITE_MODE=1
        export FORCE_CPU_ONLY=1
        
        poetry run pip install --upgrade pip
        
        # Fix NumPy/FAISS compatibility
        poetry run pip uninstall numpy -y || true
        poetry run pip install "numpy>=1.21.6,<2.0" --no-cache-dir --force-reinstall
        poetry run pip install faiss-cpu==1.7.4
        poetry run pip install torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu
        
        # Core dependencies
        poetry run pip install typer rich click pyyaml scipy scikit-learn networkx
        poetry run pip install transformers sentence-transformers datasets nltk matplotlib spacy
        poetry run pip install psutil pytest pytest-cov
        
        # Install project
        poetry run pip install -e . --no-deps
    
    - name: Verify core functionality
      run: |
        echo "ðŸ” Verifying NumPy/FAISS compatibility..."
        poetry run python -c "
        import numpy as np
        import faiss
        print(f'NumPy: {np.__version__}, FAISS: {faiss.__version__}')
        "
    
    - name: Run core tests
      run: |
        echo "ðŸ§ª Running core functionality tests..."
        mkdir -p data/raw data/processed logs
        echo "Test data for core tests" > data/raw/test_sentences.txt
        
        # Test main InsightSpike functionality
        poetry run pytest tests/ -v -k "not slow and not gpu" --tb=short --maxfail=3
        echo "âœ… Core tests completed"

  # Code quality - keep the codebase clean
  code-quality:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Poetry
      uses: snok/install-poetry@v1.4.1
      with:
        version: ${{ env.POETRY_VERSION }}
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Install code quality tools
      run: |
        poetry run pip install black isort mypy flake8
    
    - name: Check code formatting
      run: |
        echo "ðŸ” Checking code formatting..."
        poetry run black --check src/ --diff
        poetry run isort --check-only src/ --diff
    
    - name: Run type checking
      run: |
        echo "ðŸ” Running type checking..."
        poetry run mypy src/insightspike --ignore-missing-imports || echo "âš ï¸ Type checking completed with warnings"

  # Real Colab integration validation - what matters for users
  colab-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 12
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Poetry
      uses: snok/install-poetry@v1.4.1
      with:
        version: ${{ env.POETRY_VERSION }}
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Configure Poetry
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true
        poetry config installer.parallel true
    
    - name: Test Colab-like environment setup
      run: |
        export INSIGHTSPIKE_LITE_MODE=1
        export FORCE_CPU_ONLY=1
        
        # Simulate Colab environment setup
        poetry run pip install --upgrade pip
        poetry run pip uninstall numpy -y || true
        poetry run pip install "numpy>=1.21.6,<2.0" --no-cache-dir --force-reinstall
        poetry run pip install faiss-cpu==1.7.4
        poetry run pip install torch --index-url https://download.pytorch.org/whl/cpu
        
        # Essential InsightSpike dependencies
        poetry run pip install typer rich click pyyaml scipy scikit-learn networkx
        poetry run pip install transformers sentence-transformers datasets
        poetry run pip install psutil
        
        # Install project
        poetry run pip install -e . --no-deps
        
        echo "âœ… Colab-like environment setup completed"
    
    - name: Validate Colab integration scripts
      run: |
        echo "ðŸ§ª Testing Colab setup scripts..."
        if [ -f scripts/colab/setup_colab.sh ]; then
          chmod +x scripts/colab/setup_colab.sh
          bash -n scripts/colab/setup_colab.sh
        fi
        
        if [ -f scripts/colab/validate_poetry_resolution.py ]; then
          poetry run python scripts/colab/validate_poetry_resolution.py --project-root . || echo "âš ï¸ Validation completed with warnings"
        fi
        
        echo "âœ… Colab integration validated"
    
    - name: Test real InsightSpike workflow
      run: |
        echo "ðŸš€ Testing real InsightSpike workflow in Colab-like environment..."
        mkdir -p data/raw logs
        echo "Sample text for InsightSpike analysis" > data/raw/sample.txt
        
        # Test basic InsightSpike functionality
        poetry run python -c "
        import sys
        sys.path.append('src')
        from insightspike.core.engine import InsightEngine
        from insightspike.core.data_processor import DataProcessor
        
        print('âœ… InsightSpike imports successful')
        
        # Test basic functionality
        processor = DataProcessor()
        print('âœ… DataProcessor initialized')
        
        print('âœ… Real InsightSpike workflow test completed')
        "
        
        echo "âœ… Real workflow validation completed"
