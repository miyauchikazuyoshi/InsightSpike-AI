name: InsightSpike-AI CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: "3.11.12"
  POETRY_VERSION: "1.8.3"

jobs:
  # Core functionality tests - streamlined
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install Poetry
      uses: snok/install-poetry@v1.4.1
      with:
        version: ${{ env.POETRY_VERSION }}
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Configure environment
      run: |
        poetry config virtualenvs.create true
        poetry config virtualenvs.in-project true
        poetry config installer.parallel true
        echo "PYTHONPATH=$PYTHONPATH:$(pwd)/src" >> $GITHUB_ENV
        echo "INSIGHTSPIKE_LITE_MODE=1" >> $GITHUB_ENV
    
    - name: Install dependencies
      run: |
        # Install core dependencies (CI group includes test dependencies)
        poetry install --with ci --no-root
        # Install project in development mode
        poetry run pip install -e . --no-deps
    
    - name: Create test data
      run: |
        mkdir -p data/raw logs
        echo "Test data for integration tests" > data/raw/test_sentences.txt
    
    - name: Run tests
      run: |
        echo "üß™ Running tests..."
        poetry run pytest --version
        poetry run pytest tests/unit/test_config.py -v
        poetry run pytest tests/unit/test_utils.py -v  
        poetry run pytest tests/test_mvp_integration.py -v -k "not gpu"
        echo "‚úÖ All tests completed"

  # Code quality check - simplified
  quality:
    runs-on: ubuntu-latest
    timeout-minutes: 8
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install tools
      run: |
        pip install black isort mypy flake8
    
    - name: Run quality checks
      run: |
        echo "üîß Running code quality checks..."
        black src/ --check --diff || (echo "‚ö†Ô∏è Code formatting issues found" && exit 0)
        isort src/ --check-only --diff || echo "‚ö†Ô∏è Import sorting issues found"
        mypy src/insightspike --ignore-missing-imports || echo "‚ö†Ô∏è Type checking completed with warnings"
        echo "‚úÖ Quality checks completed"
