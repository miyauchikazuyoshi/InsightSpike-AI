#!/usr/bin/env bash
set -euo pipefail

# 15x15 multi-seed runner with paper-default presets.
# Usage: ./scripts/run_15x15_seeds.sh 5 7 12 21 33 57 77
# Optional env overrides:
#   MAX_STEPS=800 BRAID=0.05 GOAL_FARTHEST=1 COPY_VIEWER=1 \
#   SP_SAMPLES=250 SP_BUDGET=35 SP_FORCE_SAMPLES=120 SP_FORCE_BUDGET=12 \
#   NA_TAU=-0.004 BT_TAU=-0.018 HOP_MAX=3 \
#   FORCE_L1_TAU=0.70 FORCE_L1_TOPK=1 L1_TAU=1.10 L1_TOPK=8

SEEDS=("$@")
BASE_OUT="docs/images/gedegkaisetsu"

MAX=${MAX_STEPS:-800}
BRAID=${BRAID:-0.05}
GOAL_FARTHEST=${GOAL_FARTHEST:-1}
COPY_VIEWER=${COPY_VIEWER:-1}

SP_SAMPLES=${SP_SAMPLES:-250}
SP_BUDGET=${SP_BUDGET:-35}
SP_FORCE_SAMPLES=${SP_FORCE_SAMPLES:-120}
SP_FORCE_BUDGET=${SP_FORCE_BUDGET:-12}

NA_TAU=${NA_TAU:--0.004}
BT_TAU=${BT_TAU:--0.018}
HOP_MAX=${HOP_MAX:-3}

FORCE_L1_TAU=${FORCE_L1_TAU:-0.70}
FORCE_L1_TOPK=${FORCE_L1_TOPK:-1}
L1_TAU=${L1_TAU:-1.10}
L1_TOPK=${L1_TOPK:-8}

for S in "${SEEDS[@]}"; do
  OUT_DIR="$BASE_OUT/threshold_dfs_live_15_s${S}"
  mkdir -p "$OUT_DIR"
  echo "== 15x15 seed $S -> $OUT_DIR (max-steps=$MAX) =="

  MAZE_COPY_VIEWER="$COPY_VIEWER" \
  MAZE_BRAID_PROB="$BRAID" MAZE_GOAL_FARTHEST="$GOAL_FARTHEST" \
  MAZE_USE_QUERY_HUB=1 MAZE_QUERY_HUB_PERSIST=0 MAZE_QUERY_HUB_CONNECT_CURRENT=1 \
  MAZE_SP_GLOBAL_ENABLE=1 MAZE_SP_POSLEVEL=1 MAZE_SP_GLOBAL_SAMPLES="$SP_SAMPLES" MAZE_SP_GLOBAL_BUDGET_MS="$SP_BUDGET" \
  MAZE_SP_FORCE_ON_NA=1 MAZE_SP_FORCE_SAMPLES="$SP_FORCE_SAMPLES" MAZE_SP_FORCE_BUDGET_MS="$SP_FORCE_BUDGET" \
  MAZE_NA_GE_THRESH="$NA_TAU" MAZE_BT_AGG=na_min MAZE_BACKTRACK_THRESHOLD="$BT_TAU" MAZE_BACKTRACK_TARGET=semantic MAZE_GEDIG_THRESHOLD=0.0 \
  MAZE_ESCALATE_REEVAL=0 MAZE_ESCALATE_RING=0 MAZE_WIRING_WINDOW=0 MAZE_SPATIAL_GATE=0 \
  MAZE_WIRING_TOPK=3 MAZE_WIRING_MIN_ACCEPT=1 MAZE_WIRING_FORCE_L1=1 MAZE_WIRING_FORCE_L1_TAU="$FORCE_L1_TAU" MAZE_WIRING_FORCE_L1_TOPK="$FORCE_L1_TOPK" \
  MAZE_L1_NORM_SEARCH=1 MAZE_L1_WEIGHTED=1 MAZE_L1_UNIT_NORM=1 MAZE_L1_FILTER_UNVISITED=0 \
  MAZE_INDEX_INCLUDE_WALLS=1 \
  MAZE_L1_INDEX_SEARCH=1 \
  MAZE_L1_WEIGHTS=1,1,0,0,6,4,0,0 MAZE_L1_NORM_TAU="$L1_TAU" MAZE_L1_CAND_TOPK="$L1_TOPK" \
  MAZE_USE_HOP_DECISION=1 MAZE_HOP_DECISION_LEVEL=min MAZE_HOP_DECISION_MAX="$HOP_MAX" \
  python experiments/maze-navigation-enhanced/src/visualization/export_threshold_dfs_run.py \
    --size 15 --seed "$S" --max-steps "$MAX" --out-dir "$OUT_DIR" || echo "seed $S run failed or timed out"
done

echo "Done. Open each OUT_DIR/index.html (viewer copied) to inspect results."
