%% InsightSpike-AI Data Flow Architecture v2
%% Updated: 2025-07-13 - Query Transformation Data Flow

flowchart TB
    %% Data Sources
    subgraph "üì• Data Sources"
        DS1[User Input]
        DS2[Document Corpus]
        DS3[Q&A Datasets]
        DS4[Experiment Data]
    end
    
    %% Query Transformation Data
    subgraph "üîÑ Query Transformation Data"
        direction TB
        
        subgraph "Query States"
            QS_Init[Initial Query State]
            QS_Expl[Exploring State]
            QS_Trans[Transforming State]
            QS_Insight[Insight State]
        end
        
        subgraph "Query History"
            QH_DB[data/db/query_history.db<br/>Evolution Tracking]
            QH_Meta[Transformation Metadata]
            QH_Pattern[Success Patterns]
        end
        
        QS_Init --> QS_Expl
        QS_Expl --> QS_Trans
        QS_Trans --> QS_Insight
        QS_Insight --> QH_DB
        QH_DB --> QH_Meta
        QH_DB --> QH_Pattern
    end
    
    %% Main Data Directory Structure
    subgraph "üìÅ Main Data Directory (/data)"
        direction TB
        
        subgraph "Core System Files"
            Core[data/core/]
            Core_Ep[episodes.json<br/>Episode Metadata]
            Core_Idx[index.faiss<br/>Vector Index]
            Core_Graph[graph_pyg.pt<br/>Knowledge Graph]
            Core_Scale[scalable_index.faiss<br/>Scalable FAISS]
            
            Core --> Core_Ep
            Core --> Core_Idx
            Core --> Core_Graph
            Core --> Core_Scale
        end
        
        subgraph "Databases"
            DB[data/db/]
            DB_Insights[insight_facts.db<br/>Discovered Insights]
            DB_Learn[unknown_learning.db<br/>Learning Progress]
            DB_Query[query_history.db<br/>‚ö° NEW]
            
            DB --> DB_Insights
            DB --> DB_Learn
            DB --> DB_Query
        end
        
        subgraph "Other Directories"
            Raw[data/raw/<br/>Input Data]
            Proc[data/processed/<br/>Processed Data]
            Cache[data/cache/<br/>Temporary Cache]
            Logs[~/.insightspike/logs/<br/>System Logs]
            Config[~/.insightspike/config/<br/>SimpleConfig]
        end
    end
    
    %% Experiment Data Flow
    subgraph "üß™ Experiment Data Flow"
        direction LR
        
        subgraph "Experiment Structure"
            Exp_Root[experiments/]
            Exp_Active[active_experiments/<br/>Current Work]
            Exp_Archive[archive/<br/>Completed]
            Exp_Template[template/<br/>Baseline]
        end
        
        subgraph "Experiment Process"
            EP1[Create Backup]
            EP2[Run Experiment]
            EP3[Save Results]
            EP4[Merge/Discard]
        end
        
        Exp_Root --> Exp_Active
        Exp_Root --> Exp_Archive
        Exp_Root --> Exp_Template
        
        EP1 --> EP2
        EP2 --> EP3
        EP3 --> EP4
    end
    
    %% Processing Pipeline
    subgraph "‚öôÔ∏è Processing Pipeline"
        direction TB
        
        subgraph "Embedding Pipeline"
            P1[Text Chunking]
            P2[Embedding Generation<br/>all-MiniLM-L6-v2]
            P3[Vector Storage<br/>FAISS Index]
        end
        
        subgraph "Graph Pipeline"
            G1[Episode Analysis]
            G2[Graph Construction<br/>PyTorch Geometric]
            G3[Edge Generation<br/>geDIG Analysis]
        end
        
        subgraph "Query Evolution Pipeline"
            Q1[Query Embedding]
            Q2[Graph Placement]
            Q3[Message Passing<br/>‚ö° GNN]
            Q4[Concept Absorption]
            Q5[State Update]
        end
        
        P1 --> P2 --> P3
        G1 --> G2 --> G3
        Q1 --> Q2 --> Q3 --> Q4 --> Q5
    end
    
    %% Data Interactions
    subgraph "üîÑ Data Interactions"
        direction TB
        
        I1[Read/Write<br/>Operations]
        I2[Index Updates<br/>Incremental]
        I3[Graph Updates<br/>Batch Processing]
        I4[Query History<br/>‚ö° Tracking]
        
        subgraph "Consistency"
            C1[Episode-Index Sync]
            C2[Graph-Episode Sync]
            C3[Backup Verification]
            C4[Query Pattern Learning]
        end
    end
    
    %% Flow Connections
    DS1 --> P1
    DS2 --> P1
    DS3 --> P1
    DS4 --> Exp_Active
    
    P3 --> Core_Idx
    P3 --> Core_Scale
    G3 --> Core_Graph
    
    Core_Ep --> G1
    Core_Graph --> Q2
    Q5 --> QH_DB
    QH_Pattern --> Q3
    
    Exp_Active --> EP1
    EP4 --> Core_Ep
    EP4 --> Exp_Archive
    
    I1 -.-> Core_Ep
    I2 -.-> Core_Idx
    I3 -.-> Core_Graph
    I4 -.-> DB_Query
    
    %% Backup and Recovery
    subgraph "üíæ Backup & Recovery"
        BR1[Automatic Backups<br/>Experiment Start]
        BR2[Manual Backups<br/>CLI Commands]
        BR3[State Recovery<br/>Rollback Support]
    end
    
    Core --> BR1
    BR1 --> Exp_Template
    BR2 --> Exp_Archive
    BR3 --> Core
    
    %% Performance Indicators
    Core_Scale -.- |"100K+ Episodes<br/>O(n log n)"| P3
    Core_Graph -.- |"Incremental Updates<br/>Fast Edge Generation"| G3
    QH_DB -.- |"Evolution Tracking<br/>Pattern Learning"| Q5
    
    %% Styling
    classDef source fill:#e3f2fd
    classDef core fill:#f3e5f5
    classDef db fill:#e8f5e9
    classDef experiment fill:#fff3e0
    classDef process fill:#fce4ec
    classDef interaction fill:#e0f2f1
    classDef backup fill:#f1f8e9
    classDef query fill:#ffeb3b,stroke:#f57f17,stroke-width:3px
    
    class DS1,DS2,DS3,DS4 source
    class Core,Core_Ep,Core_Idx,Core_Graph,Core_Scale core
    class DB,DB_Insights,DB_Learn,DB_Query db
    class Exp_Root,Exp_Active,Exp_Archive,Exp_Template,EP1,EP2,EP3,EP4 experiment
    class P1,P2,P3,G1,G2,G3,Q1,Q2,Q3,Q4,Q5 process
    class I1,I2,I3,I4,C1,C2,C3,C4 interaction
    class BR1,BR2,BR3 backup
    class QS_Init,QS_Expl,QS_Trans,QS_Insight,QH_DB,QH_Meta,QH_Pattern query