%% InsightSpike-AI Workflow Tree
%% Complete workflow for insight discovery, registration, and utilization

flowchart TD
    %% Entry Points
    User[üë§ User] --> CLI{üñ•Ô∏è CLI Interface}
    User --> API{üîå API Interface}
    
    %% CLI Commands (New spike commands)
    CLI --> Query[‚ùì spike query Question]
    CLI --> Embed[üìÑ spike embed Document Embedding]
    CLI --> Insights[üß† spike insights]
    CLI --> Search[üîç spike insights-search]
    CLI --> Validate[‚úÖ spike insights-validate]
    CLI --> Cleanup[üßπ spike insights-cleanup]
    CLI --> Stats[üìä spike stats]
    
    %% Main Processing Flow
    Query --> MainAgent[ü§ñ MainAgent]
    Embed --> DocumentLoader[üìÑ Document Loader]
    API --> MainAgent
    
    %% 4-Layer Architecture
    MainAgent --> Layer1[üì• Layer 1: Input Processing]
    Layer1 --> Layer2[üîç Layer 2: Memory Retrieval]
    Layer2 --> Layer3[üßÆ Layer 3: Graph Reasoning]
    Layer3 --> Layer4[ü§ñ Layer 4: LLM Provider]
    
    %% Layer Details
    Layer1 --> InputValidation[Input Validation]
    Layer1 --> ContextFormatting[Context Formatting]
    
    Layer2 --> EpisodeSearch[Episode Search]
    Layer2 --> VectorRetrieval[Vector Retrieval]
    Layer2 --> MemoryDB[üóÉÔ∏è Memory Database]
    
    Layer3 --> GraphAnalysis[Graph Analysis]
    Layer3 --> ConceptMapping[Concept Mapping]
    Layer3 --> GraphDB[üï∏Ô∏è Graph Database]
    
    Layer4 --> UnifiedLLM[üè† UnifiedLLMProvider]
    UnifiedLLM --> LocalLLM[Local LLM]
    UnifiedLLM --> MockLLM[Mock LLM safe_mode]
    UnifiedLLM --> ModelProcessing[Model Processing]
    
    %% Response Processing
    Layer4 --> ResponseGeneration[üìù Response Generation]
    ResponseGeneration --> InsightExtraction[üí° Insight Extraction]
    
    %% Insight Registration System
    InsightExtraction --> QualityAssessment[üìã Quality Assessment]
    QualityAssessment --> InsightRegistry[üß† InsightFactRegistry]
    
    %% Quality Criteria
    QualityAssessment --> Confidence[Confidence]
    QualityAssessment --> Novelty[Novelty]
    QualityAssessment --> Coherence[Coherence]
    QualityAssessment --> Specificity[Specificity]
    
    %% Insight Storage
    InsightRegistry --> InsightDB[üíæ Insight Database]
    InsightDB --> SQLiteStorage[SQLite Storage]
    
    %% Insight Management
    Insights --> ShowStats[Display Statistics]
    Search --> ConceptSearch[Concept Search]
    Validate --> ManualValidation[Manual Validation]
    Cleanup --> QualityFiltering[Quality Filtering]
    
    %% Document Loading Flow
    DocumentLoader --> LoadDocuments[Load Documents]
    LoadDocuments --> Embedder[Generate Embeddings]
    Embedder --> Layer2
    
    %% Feedback Loop
    InsightRegistry --> FeedbackLoop[üîÑ Feedback Loop]
    FeedbackLoop --> Layer2
    FeedbackLoop --> Layer3
    
    %% Output to User
    ResponseGeneration --> UserResponse[üì§ Response to User]
    ShowStats --> UserResponse
    ConceptSearch --> UserResponse
    ManualValidation --> UserResponse
    
    %% Configuration System (Pydantic-based)
    Config[‚öôÔ∏è InsightSpikeConfig] --> MainAgent
    Config --> ConfigLoader[üìã Config Loader]
    ConfigLoader --> EnvVars[üåç Environment Variables]
    ConfigLoader --> ConfigYAML[üìÑ config.yaml]
    ConfigLoader --> Presets[üìã Built-in Presets]
    Presets --> Development[üîß development]
    Presets --> Testing[üß™ testing]
    Presets --> Production[üöÄ production]
    Presets --> Experiment[üß¨ experiment]
    Presets --> Cloud[‚òÅÔ∏è cloud]
    
    %% Data Flow Styling
    classDef userInterface fill:#e1f5fe
    classDef processing fill:#f3e5f5
    classDef storage fill:#e8f5e8
    classDef insight fill:#fff3e0
    classDef feedback fill:#fce4ec
    
    class User,CLI,API userInterface
    class MainAgent,Layer1,Layer2,Layer3,Layer4 processing
    class MemoryDB,GraphDB,InsightDB,SQLiteStorage storage
    class InsightExtraction,QualityAssessment,InsightRegistry insight
    class FeedbackLoop feedback
