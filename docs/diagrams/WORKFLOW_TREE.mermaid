%% InsightSpike-AI Workflow Tree
%% Ê¥ûÂØüÁô∫Ë¶ã„ÉªÁôªÈå≤„ÉªÊ¥ªÁî®„ÅÆÂÆåÂÖ®„ÉØ„Éº„ÇØ„Éï„É≠„Éº

flowchart TD
    %% Entry Points
    User[üë§ „É¶„Éº„Ç∂„Éº] --> CLI{üñ•Ô∏è CLI Interface}
    User --> API{üîå API Interface}
    
    %% CLI Commands (New spike commands)
    CLI --> Query[‚ùì spike query Ë≥™Âïè]
    CLI --> Embed[üìÑ spike embed „Éâ„Ç≠„É•„É°„É≥„ÉàÂüã„ÇÅËæº„Åø]
    CLI --> Insights[üß† spike insights]
    CLI --> Search[üîç spike insights-search]
    CLI --> Validate[‚úÖ spike insights-validate]
    CLI --> Cleanup[üßπ spike insights-cleanup]
    CLI --> Stats[üìä spike stats]
    
    %% Main Processing Flow
    Query --> MainAgent[ü§ñ MainAgent]
    Embed --> DocumentLoader[üìÑ Document Loader]
    API --> MainAgent
    
    %% 4-Layer Architecture
    MainAgent --> Layer1[üì• Layer 1: Input Processing]
    Layer1 --> Layer2[üîç Layer 2: Memory Retrieval]
    Layer2 --> Layer3[üßÆ Layer 3: Graph Reasoning]
    Layer3 --> Layer4[ü§ñ Layer 4: LLM Provider]
    
    %% Layer Details
    Layer1 --> InputValidation[ÂÖ•ÂäõÊ§úË®º]
    Layer1 --> ContextFormatting[„Ç≥„É≥„ÉÜ„Ç≠„Çπ„ÉàÊï¥ÂΩ¢]
    
    Layer2 --> EpisodeSearch[„Ç®„Éî„ÇΩ„Éº„ÉâÊ§úÁ¥¢]
    Layer2 --> VectorRetrieval[„Éô„ÇØ„Éà„É´Ê§úÁ¥¢]
    Layer2 --> MemoryDB[(üóÉÔ∏è Memory Database)]
    
    Layer3 --> GraphAnalysis[„Ç∞„É©„ÉïËß£Êûê]
    Layer3 --> ConceptMapping[Ê¶ÇÂøµ„Éû„ÉÉ„Éî„É≥„Ç∞]
    Layer3 --> GraphDB[(üï∏Ô∏è Graph Database)]
    
    Layer4 --> UnifiedLLM[üè† UnifiedLLMProvider]
    UnifiedLLM --> LocalLLM[Local LLM]
    UnifiedLLM --> MockLLM[Mock LLM (safe_mode)]
    UnifiedLLM --> ModelProcessing[„É¢„Éá„É´Âá¶ÁêÜ]
    
    %% Response Processing
    Layer4 --> ResponseGeneration[üìù ÂøúÁ≠îÁîüÊàê]
    ResponseGeneration --> InsightExtraction[üí° Ê¥ûÂØüÊäΩÂá∫]
    
    %% Insight Registration System
    InsightExtraction --> QualityAssessment[üìã ÂìÅË≥™Ë©ï‰æ°]
    QualityAssessment --> InsightRegistry[üß† InsightFactRegistry]
    
    %% Quality Criteria
    QualityAssessment --> Confidence[‰ø°È†ºÂ∫¶]
    QualityAssessment --> Novelty[Êñ∞Ë¶èÊÄß]
    QualityAssessment --> Coherence[‰∏ÄË≤´ÊÄß]
    QualityAssessment --> Specificity[ÂÖ∑‰ΩìÊÄß]
    
    %% Insight Storage
    InsightRegistry --> InsightDB[(üíæ Insight Database)]
    InsightDB --> SQLiteStorage[SQLite „Çπ„Éà„É¨„Éº„Ç∏]
    
    %% Insight Management
    Insights --> ShowStats[Áµ±Ë®àË°®Á§∫]
    Search --> ConceptSearch[Ê¶ÇÂøµÊ§úÁ¥¢]
    Validate --> ManualValidation[ÊâãÂãïÊ§úË®º]
    Cleanup --> QualityFiltering[ÂìÅË≥™„Éï„Ç£„É´„Çø„É™„É≥„Ç∞]
    
    %% Document Loading Flow
    DocumentLoader --> LoadDocuments[„Éâ„Ç≠„É•„É°„É≥„ÉàË™≠„ÅøËæº„Åø]
    LoadDocuments --> Embedder[Âüã„ÇÅËæº„ÅøÁîüÊàê]
    Embedder --> Layer2
    
    %% Feedback Loop
    InsightRegistry --> FeedbackLoop[üîÑ „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„É´„Éº„Éó]
    FeedbackLoop --> Layer2
    FeedbackLoop --> Layer3
    
    %% Output to User
    ResponseGeneration --> UserResponse[üì§ „É¶„Éº„Ç∂„Éº„Å∏„ÅÆÂøúÁ≠î]
    ShowStats --> UserResponse
    ConceptSearch --> UserResponse
    ManualValidation --> UserResponse
    
    %% Configuration System (Pydantic-based)
    Config[‚öôÔ∏è InsightSpikeConfig] --> MainAgent
    Config --> ConfigLoader[üìã Config Loader]
    ConfigLoader --> EnvVars[üåç Environment Variables]
    ConfigLoader --> ConfigYAML[üìÑ config.yaml]
    ConfigLoader --> Presets[üìã Built-in Presets]
    Presets --> Development[üîß development]
    Presets --> Testing[üß™ testing]
    Presets --> Production[üöÄ production]
    Presets --> Experiment[üß¨ experiment]
    Presets --> Cloud[‚òÅÔ∏è cloud]
    
    %% Data Flow Styling
    classDef userInterface fill:#e1f5fe
    classDef processing fill:#f3e5f5
    classDef storage fill:#e8f5e8
    classDef insight fill:#fff3e0
    classDef feedback fill:#fce4ec
    
    class User,CLI,API userInterface
    class MainAgent,Layer1,Layer2,Layer3,Layer4 processing
    class MemoryDB,GraphDB,InsightDB,SQLiteStorage storage
    class InsightExtraction,QualityAssessment,InsightRegistry insight
    class FeedbackLoop feedback
