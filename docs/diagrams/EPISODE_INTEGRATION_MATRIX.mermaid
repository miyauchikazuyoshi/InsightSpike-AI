%% Episode Management Decision Matrix
%% ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ç®¡ç†ã®åˆ¤å®šãƒãƒˆãƒªãƒƒã‚¯ã‚¹

flowchart TD
    %% New Episode Input
    NewEpisode[ğŸ“¥ New Episode<br/>Vector + Text + C-value]
    
    %% Integration Check Process
    subgraph "ğŸ” Integration Decision Process"
        direction TB
        
        %% Similarity Calculation
        VectorSim[ğŸ“Š Vector Similarity<br/>Cosine Distance]
        ContentOver[ğŸ“ Content Overlap<br/>Word-level Jaccard]
        CValueComp[âš–ï¸ C-Value Compatibility<br/>Importance Difference]
        
        %% Threshold Checks
        subgraph "ğŸ¯ Threshold Checks"
            SimThresh[Vector Similarity â‰¥ 0.85]
            ContThresh[Content Overlap â‰¥ 0.4]
            IntegThresh[Integration Score â‰¥ 0.65]
        end
        
        %% Integration Score
        IntegScore[ğŸ§® Integration Score<br/>0.5Ã—Sim + 0.3Ã—Content + 0.2Ã—C-Compat]
    end
    
    %% Decision Matrix
    subgraph "ğŸ¯ Decision Matrix"
        direction LR
        
        subgraph "âœ… INTEGRATE Conditions"
            HighSim[High Similarity â‰¥ 0.85]
            HighCont[High Content â‰¥ 0.4] 
            HighInteg[High Integration â‰¥ 0.65]
        end
        
        subgraph "â• NEW NODE Conditions"
            LowSim[Low Similarity < 0.85]
            LowCont[Low Content < 0.4]
            LowInteg[Low Integration < 0.65]
        end
    end
    
    %% Actions
    subgraph "ğŸ”„ Actions"
        direction TB
        
        subgraph "ğŸ”— Integration Process"
            MergeVec[Weighted Vector Average]
            CombineText[Text Combination with |]
            MaxCValue[Max C-Value Selection]
            UpdateMeta[Integration History Update]
        end
        
        subgraph "â• New Node Process"
            AddEpisode[Add as New Episode]
            TrainIndex[Update FAISS Index]
            IncrementCount[Increment Episode Count]
        end
    end
    
    %% Flow
    NewEpisode --> VectorSim
    NewEpisode --> ContentOver
    NewEpisode --> CValueComp
    
    VectorSim --> IntegScore
    ContentOver --> IntegScore
    CValueComp --> IntegScore
    
    IntegScore --> SimThresh
    IntegScore --> ContThresh
    IntegScore --> IntegThresh
    
    SimThresh -->|AND| Decision{Integration Decision}
    ContThresh -->|AND| Decision
    IntegThresh -->|AND| Decision
    
    Decision -->|All Met| HighSim
    Decision -->|Any Failed| LowSim
    
    HighSim --> MergeVec
    HighCont --> CombineText
    HighInteg --> MaxCValue
    
    LowSim --> AddEpisode
    LowCont --> TrainIndex
    LowInteg --> IncrementCount
    
    %% Example Cases
    subgraph "ğŸ“‹ Example Cases"
        direction TB
        
        subgraph "Case 1: Similar Content"
            Ex1Input["'Machine learning algorithms learn'<br/>vs<br/>'Machine learning algorithms discover'"]
            Ex1Result[âœ… INTEGRATE<br/>Sim: 0.99, Content: 0.78]
        end
        
        subgraph "Case 2: Different Topic"
            Ex2Input["'Machine learning algorithms'<br/>vs<br/>'Quantum physics particles'"]
            Ex2Result[â• NEW NODE<br/>Sim: 0.23, Content: 0.05]
        end
        
        subgraph "Case 3: High Sim, Low Content"
            Ex3Input["High vector similarity<br/>but different meaning"]
            Ex3Result[â• NEW NODE<br/>Sim: 0.89, Content: 0.12]
        end
    end
    
    %% Styling
    classDef integrationClass fill:#e8f5e8
    classDef newNodeClass fill:#fff3e0
    classDef processClass fill:#e1f5fe
    classDef exampleClass fill:#f3e5f5
    
    class HighSim,HighCont,HighInteg,MergeVec,CombineText,MaxCValue,UpdateMeta,Ex1Result integrationClass
    class LowSim,LowCont,LowInteg,AddEpisode,TrainIndex,IncrementCount,Ex2Result,Ex3Result newNodeClass
    class VectorSim,ContentOver,CValueComp,IntegScore,SimThresh,ContThresh,IntegThresh processClass
    class Ex1Input,Ex2Input,Ex3Input exampleClass
