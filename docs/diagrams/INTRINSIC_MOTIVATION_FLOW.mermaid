%% Intrinsic Motivation and Episode Management Flow
%% å†…ç™ºå ±é…¬ã¨ã‚¨ãƒ”ã‚½ãƒ¼ãƒ‰ç®¡ç†ã®ãƒ•ãƒ­ãƒ¼å›³

flowchart TD
    %% Input and Processing
    Query[ğŸ¤” User Query] --> L1[L1: Error Monitor]
    L1 --> L2[L2: Memory Manager]
    L2 --> L3[L3: Graph Reasoner]
    L3 --> L4[L4: LLM Interface]
    
    %% Memory Search and Episode Check
    subgraph "ğŸ§  Memory Management"
        direction TB
        Search[ğŸ“š Episode Search]
        NewEpisode[â• New Episode]
        
        subgraph "Integration Decision"
            Check[ğŸ” Integration Check]
            SimThresh[Vector Similarity â‰¥ 0.85]
            ContentThresh[Content Overlap â‰¥ 0.4]
            IntegScore[Integration Score â‰¥ 0.65]
        end
        
        Check --> SimThresh
        Check --> ContentThresh
        Check --> IntegScore
        
        NewEpisode --> Check
        Check -->|All Met| Integrate[ğŸ”„ Integrate with Existing]
        Check -->|Not Met| AddNew[â• Add as New Node]
    end
    
    %% Graph Analysis and Intrinsic Reward
    subgraph "ğŸ“Š Graph Analysis"
        direction TB
        GraphBuild[ğŸ•¸ï¸ Graph Construction]
        MetricsCalc[ğŸ“ˆ Î”GED/Î”IG Calculation]
        
        subgraph "Intrinsic Reward Components"
            BaseReward[Base: Î”IG - 0.5Ã—Î”GED]
            NoveltyReward[Novelty: Î”IG - 0.5Ã—Conflict]
            StructureReward[Structure: Graph Quality]
        end
        
        MetricsCalc --> BaseReward
        MetricsCalc --> NoveltyReward
        MetricsCalc --> StructureReward
        
        TotalReward[ğŸ¯ Total Intrinsic Reward]
        BaseReward --> TotalReward
        NoveltyReward --> TotalReward
        StructureReward --> TotalReward
    end
    
    %% Spike Detection and Memory Updates
    subgraph "âš¡ Spike Detection"
        direction TB
        SpikeCheck[ğŸ” Eureka Spike Check]
        
        subgraph "Spike Conditions"
            HighReward[High Intrinsic Reward > 0.5]
            LowGED[Low Î”GED < 0.2]
            HighIG[High Î”IG > 0.2]
        end
        
        SpikeCheck --> HighReward
        SpikeCheck --> LowGED
        SpikeCheck --> HighIG
        
        SpikeDetected[âš¡ Spike Detected!]
        HighReward -->|AND| SpikeDetected
        LowGED -->|AND| SpikeDetected
        HighIG -->|AND| SpikeDetected
    end
    
    %% Episode Management Triggers
    subgraph "ğŸ”„ Episode Management"
        direction TB
        UpdateCValues[ğŸ“ˆ C-Value Updates]
        
        subgraph "Management Triggers"
            direction LR
            MergeTrigger[ğŸ”— Merge Trigger<br/>Low Î”GED + High Similarity]
            SplitTrigger[âœ‚ï¸ Split Trigger<br/>High Conflict + Complexity]
            PruneTrigger[ğŸ—‘ï¸ Prune Trigger<br/>Low C-Values]
        end
        
        UpdateCValues --> MergeTrigger
        UpdateCValues --> SplitTrigger
        UpdateCValues --> PruneTrigger
        
        subgraph "Actions"
            MergeEpisodes[ğŸ”— Merge Similar Episodes]
            SplitEpisodes[âœ‚ï¸ Split Complex Episodes]
            PruneEpisodes[ğŸ—‘ï¸ Remove Low-Value Episodes]
        end
        
        MergeTrigger -->|Similarity > 0.8| MergeEpisodes
        SplitTrigger -->|Conflict > 0.7| SplitEpisodes
        PruneTrigger -->|C-Value < 0.1| PruneEpisodes
    end
    
    %% Flow Connections
    L2 --> Search
    Search --> GraphBuild
    GraphBuild --> MetricsCalc
    TotalReward --> SpikeCheck
    SpikeDetected --> UpdateCValues
    
    MergeEpisodes --> IndexRetrain[ğŸ”„ Index Retrain]
    SplitEpisodes --> IndexRetrain
    PruneEpisodes --> IndexRetrain
    IndexRetrain --> OptimizedMemory[ğŸ§  Optimized Memory]
    
    %% Output
    L4 --> Response[ğŸ“ Enhanced Response]
    OptimizedMemory --> FutureQueries[ğŸ”® Future Queries]
    
    %% Styling
    classDef memoryClass fill:#e1f5fe
    classDef graphClass fill:#f3e5f5
    classDef spikeClass fill:#fff3e0
    classDef managementClass fill:#e8f5e8
    
    class Search,NewEpisode,Check,Integrate,AddNew memoryClass
    class GraphBuild,MetricsCalc,BaseReward,NoveltyReward,StructureReward,TotalReward graphClass
    class SpikeCheck,HighReward,LowGED,HighIG,SpikeDetected spikeClass
    class UpdateCValues,MergeTrigger,SplitTrigger,PruneTrigger,MergeEpisodes,SplitEpisodes,PruneEpisodes managementClass
