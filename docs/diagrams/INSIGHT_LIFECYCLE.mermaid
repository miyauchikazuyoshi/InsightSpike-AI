%% Insight Lifecycle Flow
%% æ´å¯Ÿã®ç™ºè¦‹ã‹ã‚‰æ´»ç”¨ã¾ã§ã®ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«

flowchart TD
    %% Input Stage
    subgraph "ğŸ“¥ Input Stage"
        Question[â“ ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•]
        Context[ğŸ“‹ æ—¢å­˜ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ]
    end
    
    %% Processing Stage
    subgraph "âš™ï¸ Processing Stage"
        Agent[ğŸ¤– MainAgentå‡¦ç†]
        Layers[ğŸ§  4å±¤ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£]
        Response[ğŸ“ å¿œç­”ç”Ÿæˆ]
    end
    
    %% Insight Discovery
    subgraph "ğŸ’¡ Insight Discovery"
        direction TB
        Extract[ğŸ” æ´å¯ŸæŠ½å‡º]
        
        subgraph "æŠ½å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³"
            Pattern1[å› æœé–¢ä¿‚<br/>A causes B]
            Pattern2[é¡æ¨é–¢ä¿‚<br/>A is like B]
            Pattern3[çµ±åˆé–¢ä¿‚<br/>A + B = C]
            Pattern4[æ§‹é€ é–¢ä¿‚<br/>A contains B]
        end
        
        Extract --> Pattern1
        Extract --> Pattern2
        Extract --> Pattern3
        Extract --> Pattern4
    end
    
    %% Quality Assessment
    subgraph "ğŸ“Š Quality Assessment"
        direction TB
        Evaluate[å“è³ªè©•ä¾¡ã‚¨ãƒ³ã‚¸ãƒ³]
        
        subgraph "è©•ä¾¡åŸºæº–"
            Conf[ä¿¡é ¼åº¦<br/>0.0-1.0]
            Novel[æ–°è¦æ€§<br/>0.0-1.0]
            Coher[ä¸€è²«æ€§<br/>0.0-1.0]
            Spec[å…·ä½“æ€§<br/>0.0-1.0]
        end
        
        Evaluate --> Conf
        Evaluate --> Novel
        Evaluate --> Coher
        Evaluate --> Spec
        
        Score[ç·åˆã‚¹ã‚³ã‚¢è¨ˆç®—]
        Conf --> Score
        Novel --> Score
        Coher --> Score
        Spec --> Score
    end
    
    %% Registration Decision
    subgraph "âœ… Registration Decision"
        Filter{å“è³ªãƒ•ã‚£ãƒ«ã‚¿<br/>ã‚¹ã‚³ã‚¢ >= 0.6}
        Accept[âœ… ç™»éŒ²æ‰¿èª]
        Reject[âŒ ç™»éŒ²æ‹’å¦]
    end
    
    %% Storage & Indexing
    subgraph "ğŸ’¾ Storage & Indexing"
        direction TB
        Store[ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜]
        Index[ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ]
        
        subgraph "ä¿å­˜é …ç›®"
            ID[Insight ID]
            Text[æ´å¯Ÿãƒ†ã‚­ã‚¹ãƒˆ]
            Concepts[é–¢é€£æ¦‚å¿µ]
            Meta[ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿]
            Timestamp[ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—]
        end
        
        Store --> ID
        Store --> Text
        Store --> Concepts
        Store --> Meta
        Store --> Timestamp
    end
    
    %% Insight Utilization
    subgraph "ğŸ”„ Insight Utilization"
        direction TB
        
        subgraph "æ¤œç´¢ãƒ»æ´»ç”¨"
            Search[æ¦‚å¿µæ¤œç´¢]
            Context_Build[ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰]
            Reasoning[æ¨è«–æ”¯æ´]
        end
        
        subgraph "ç®¡ç†ãƒ»æœ€é©åŒ–"
            Validate[æ‰‹å‹•æ¤œè¨¼]
            Update[å“è³ªæ›´æ–°]
            Cleanup[ä½å“è³ªé™¤å»]
        end
    end
    
    %% Feedback Loop
    subgraph "ğŸ”„ Feedback Loop"
        Learn[ç¶™ç¶šå­¦ç¿’]
        Improve[å“è³ªå‘ä¸Š]
        Adapt[é©å¿œçš„èª¿æ•´]
    end
    
    %% Flow Connections
    Question --> Agent
    Context --> Agent
    Agent --> Layers
    Layers --> Response
    Response --> Extract
    
    Pattern1 --> Evaluate
    Pattern2 --> Evaluate
    Pattern3 --> Evaluate
    Pattern4 --> Evaluate
    
    Score --> Filter
    Filter -->|ã‚¹ã‚³ã‚¢ >= 0.6| Accept
    Filter -->|ã‚¹ã‚³ã‚¢ < 0.6| Reject
    
    Accept --> Store
    Store --> Index
    Index --> Search
    
    Search --> Context_Build
    Context_Build --> Reasoning
    Reasoning --> Learn
    
    Validate --> Update
    Update --> Improve
    Cleanup --> Adapt
    
    Learn -.-> Context
    Improve -.-> Evaluate
    Adapt -.-> Filter
    
    %% CLI Commands Integration
    subgraph "ğŸ–¥ï¸ CLI Commands"
        CMD1[insights<br/>çµ±è¨ˆè¡¨ç¤º]
        CMD2[insights-search<br/>æ¦‚å¿µæ¤œç´¢]
        CMD3[insights-validate<br/>æ‰‹å‹•æ¤œè¨¼]
        CMD4[insights-cleanup<br/>å“è³ªç®¡ç†]
    end
    
    Index --> CMD1
    Search --> CMD2
    Validate --> CMD3
    Cleanup --> CMD4
    
    %% Styling
    classDef input fill:#e3f2fd
    classDef process fill:#e8f5e8
    classDef discovery fill:#fff3e0
    classDef quality fill:#f3e5f5
    classDef storage fill:#fafafa
    classDef utilization fill:#e0f2f1
    classDef feedback fill:#fce4ec
    classDef cli fill:#f1f8e9
    
    class Question,Context input
    class Agent,QT,Layers,Response process
    class Extract,Pattern1,Pattern2,Pattern3,Pattern4 discovery
    class Evaluate,Conf,Novel,Coher,Spec,Score,Filter quality
    class Store,Index,ID,Text,Concepts,Meta,Timestamp storage
    class Search,Context_Build,Reasoning,Validate,Update,Cleanup utilization
    class Learn,Improve,Adapt feedback
    class CMD1,CMD2,CMD3,CMD4 cli
