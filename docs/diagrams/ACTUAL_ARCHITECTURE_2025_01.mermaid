%% InsightSpike-AI Actual Architecture (2025-01-27)
%% Current implementation reality with issues

flowchart TB
    %% User Interaction Layer
    subgraph "üë§ User Interface"
        CLI[CLI Commands<br/>spike.py]
        API[Python API]
        Notebook[Jupyter Notebooks]
    end
    
    %% Patch System (Pre-initialization)
    subgraph "üîß Patch System"
        Patches[apply_all_fixes()<br/>- Embedder shape fix<br/>- LLM provider fix<br/>- Graph analyzer fix<br/>- Enum value fix]
    end
    
    %% Configuration Chaos
    subgraph "‚ö†Ô∏è Configuration System"
        direction TB
        DictConfig[Dict Config<br/>Legacy Format]
        PydanticConfig[Pydantic Config<br/>New Format]
        SimpleNamespace[SimpleNamespace<br/>Attribute Access]
        ConfigNormalizer[ConfigNormalizer<br/>Conversion Logic]
        
        DictConfig -.->|convert| SimpleNamespace
        PydanticConfig -.->|normalize| DictConfig
        ConfigNormalizer --> |handles| DictConfig
        ConfigNormalizer --> |handles| PydanticConfig
    end
    
    %% Core Agent with Issues
    subgraph "ü§ñ Agent System (With Issues)"
        MainAgent[MainAgent<br/>‚ùå Missing l1_embedder<br/>‚ö†Ô∏è Dual config handling]
        DataStore[DataStore<br/>‚ö†Ô∏è Optional/Required confusion]
        CycleResult[CycleResult ‚úÖ<br/>Type-safe API]
    end
    
    %% Layer Architecture with Problems
    subgraph "üß† Core Intelligence Layers (Mixed State)"
        direction TB
        
        subgraph "Layer 1: Error Monitor"
            L1_Error[Error Detection ‚úÖ]
            L1_Missing[‚ùå l1_embedder missing]
        end
        
        subgraph "Layer 2: Memory Manager"
            L2_Memory[CompatibleL2MemoryManager<br/>‚ùå _encode_text missing]
            L2_Episodes[Episode Storage ‚ö†Ô∏è<br/>Shape issues (1,384) vs (384,)]
            L2_Cache[CachedMemoryManager<br/>‚ö†Ô∏è Incomplete implementation]
        end
        
        subgraph "Layer 3: Graph Reasoner"
            L3_Graph[Graph Analysis ‚ö†Ô∏è<br/>NetworkX/PyG confusion]
            L3_Builder[ScalableGraphBuilder<br/>‚ùå Config access issues]
            L3_Analyzer[GraphAnalyzer<br/>‚ùå num_nodes errors]
            L3_Adapter[GraphTypeAdapter<br/>‚ö†Ô∏è Incomplete conversions]
        end
        
        subgraph "Layer 4: LLM Interface"
            L4_LLM[LLM Provider ‚ö†Ô∏è<br/>Enum value access chaos]
            L4_Registry[LLMProviderRegistry<br/>‚ùå Dict handling issues]
        end
    end
    
    %% Type Conversion Mess
    subgraph "üîÑ Type Conversion Layer"
        direction LR
        NetworkX[NetworkX Graphs]
        PyG[PyTorch Geometric]
        TypeAdapter[GraphTypeAdapter<br/>‚ö†Ô∏è Lossy conversions]
        
        NetworkX <-.->|convert| TypeAdapter
        PyG <-.->|convert| TypeAdapter
    end
    
    %% Flow with Issues
    CLI --> |requires patches| Patches
    Patches --> MainAgent
    
    CLI --> |dict config| DictConfig
    API --> |various configs| ConfigNormalizer
    
    MainAgent --> |expects dict| L1_Error
    MainAgent --> |missing attr| L1_Missing
    
    L1_Error --> L2_Memory
    L2_Memory --> |shape mismatch| L2_Episodes
    L2_Memory --> |incomplete| L2_Cache
    
    L2_Memory --> L3_Graph
    L3_Graph --> |builds| L3_Builder
    L3_Builder --> |analyzes| L3_Analyzer
    L3_Analyzer --> |needs conversion| L3_Adapter
    
    L3_Adapter --> TypeAdapter
    L3_Graph --> L4_LLM
    L4_LLM --> |registry issues| L4_Registry
    
    %% Error Paths
    L3_Analyzer -.->|"'Graph' has no attribute 'num_nodes'"| Error1[Runtime Error]
    L2_Memory -.->|"too many values to unpack"| Error2[Unpacking Error]
    MainAgent -.->|"no attribute 'l1_embedder'"| Error3[Attribute Error]
    L4_Registry -.->|"dict has no attribute 'provider'"| Error4[Config Error]
    
    %% Styling
    classDef working fill:#c8e6c9,stroke:#4caf50,stroke-width:2px
    classDef warning fill:#fff3e0,stroke:#ff9800,stroke-width:2px
    classDef error fill:#ffcdd2,stroke:#f44336,stroke-width:2px
    classDef patch fill:#e1bee7,stroke:#9c27b0,stroke-width:2px
    
    class CycleResult,L1_Error working
    class MainAgent,DataStore,L2_Memory,L2_Episodes,L3_Graph,L4_LLM,TypeAdapter,ConfigNormalizer warning
    class L1_Missing,L2_Cache,L3_Builder,L3_Analyzer,L4_Registry,Error1,Error2,Error3,Error4 error
    class Patches patch