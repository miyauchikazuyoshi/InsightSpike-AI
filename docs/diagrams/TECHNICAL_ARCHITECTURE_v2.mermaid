%% InsightSpike-AI Technical Architecture Flow v2
%% Updated: 2025-07-13 - Query Transformation Integration

flowchart LR
    %% User Interaction Layer
    subgraph "üë§ User Layer"
        U1[Terminal/CLI<br/>spike commands]
        U2[Python API]
        U3[Jupyter Notebook]
    end
    
    %% Application Layer
    subgraph "üñ•Ô∏è Application Layer"
        direction TB
        CLI_App[CLI Application<br/>spike query/embed<br/>typer + rich]
        Agent_Loop[Agent Loop<br/>agent_loop.py]
        Main_Agent[MainAgent<br/>main_agent.py<br/>‚ö° O(n log n)]
        Simple_Config[SimpleConfig<br/>Presets System]
    end
    
    %% Core Processing Layers
    subgraph "üß† Core Intelligence Layers"
        direction TB
        
        subgraph "Layer 1: Input & Query Transformation"
            L1_Input[Input Processing]
            L1_Valid[Validation]
            L1_Format[Formatting]
            L1_QT[Query Transformation<br/>‚ö° NEW]
            L1_QS[Query State Tracking<br/>(Initial‚ÜíExploring‚ÜíInsight)]
        end
        
        subgraph "Layer 2: Memory (Enhanced Scalable)"
            L2_Enhanced[L2EnhancedScalableMemory<br/>‚ö° NEW]
            L2_Episode[Episode Management<br/>(Dynamic Importance)]
            L2_SGM[ScalableGraphManager<br/>FAISS + O(n log n)]
            L2_Conflict[Conflict-Based<br/>Episode Splitting]
            L2_Vector[FAISS Vector Search<br/>(IndexFlatIP)]
        end
        
        subgraph "Layer 3: Reasoning (Graph-Enhanced)"
            L3_Graph[PyTorch Geometric Graph<br/>(Pre-built from L2)]
            L3_Builder[ScalableGraphBuilder<br/>‚ö° Efficient Updates]
            L3_GNN[GNN Message Passing<br/>‚ö° Query Evolution]
            L3_geDIG[geDIG Analysis<br/>(ŒîGED + ŒîIG)]
            L3_Spike[Spike Detection<br/>Eureka Moments]
        end
        
        subgraph "Layer 4: Generation"
            L4_LLM[UnifiedLLMProvider<br/>(TinyLlama/GPT)]
            L4_Local[LocalProvider<br/>MockProvider<br/>safe_mode support]
            L4_Response[Response Generation]
        end
    end
    
    %% Data Management System
    subgraph "üìä Data Management"
        direction TB
        
        subgraph "Core Data"
            Core_Episodes[data/core/episodes.json]
            Core_Index[data/core/index.faiss]
            Core_Graph[data/core/graph_pyg.pt]
            Core_Scalable[data/core/scalable_index.faiss]
        end
        
        subgraph "Databases"
            DB_Insights[data/db/insight_facts.db]
            DB_Learning[data/db/unknown_learning.db]
        end
        
        subgraph "Experiments"
            Exp_Active[experiments/active_experiments/]
            Exp_Archive[experiments/archive/]
            Exp_Template[experiments/template/]
        end
    end
    
    %% Experiment Workflow
    subgraph "üß™ Experiment Management"
        direction TB
        E1[Backup Main Data]
        E2[Run Experiment]
        E3[Save Results]
        E4[Restore if Needed]
        
        E1 --> E2 --> E3 --> E4
    end
    
    %% Data Flow Connections
    U1 --> CLI_App
    U2 --> Agent_Loop
    U3 --> Main_Agent
    
    CLI_App --> Main_Agent
    Agent_Loop --> Main_Agent
    Simple_Config --> Main_Agent
    Main_Agent --> L1_Input
    
    %% Layer Flow with ScalableGraphManager
    L1_Format --> L1_QT
    L1_QT --> L1_QS
    L1_QS --> L2_Enhanced
    L2_Enhanced --> L2_Episode
    L2_Episode --> L2_SGM
    L2_SGM --> L2_Conflict
    L2_Conflict --> L2_Vector
    
    %% Efficient Graph Building
    L2_SGM -.-> |Pre-built Graph| L3_Graph
    L3_Graph --> L3_Builder
    L3_Builder --> L3_GNN
    L3_GNN --> L3_geDIG
    L3_geDIG --> L3_Spike
    
    %% Query Transformation Feedback Loop
    L3_GNN -.-> |Query Evolution| L1_QS
    L3_Spike --> L4_LLM
    L4_LLM --> L4_Local --> L4_Response
    
    %% Storage Connections
    L2_Vector -.-> Core_Index
    L2_Episode -.-> Core_Episodes
    L2_SGM -.-> Core_Scalable
    L3_Graph -.-> Core_Graph
    
    %% Database Connections
    L4_Response -.-> DB_Insights
    Main_Agent -.-> DB_Learning
    
    %% Experiment Flow
    Main_Agent --> E1
    E3 --> Exp_Active
    
    %% Performance Indicators
    Main_Agent -.- |"O(n log n)<br/>Scalable Performance"| L2_SGM
    L2_SGM -.- |"FAISS Index<br/>Fast Search"| L2_Vector
    L3_Builder -.- |"Incremental<br/>Updates"| L3_Graph
    
    %% Styling
    classDef userLayer fill:#e3f2fd
    classDef appLayer fill:#f3e5f5
    classDef enhanced fill:#c8e6c9,stroke:#4caf50,stroke-width:3px
    classDef dataLayer fill:#fff3e0
    classDef expLayer fill:#f3e5f5
    
    class U1,U2,U3 userLayer
    class CLI_App,Agent_Loop,Main_Agent appLayer
    class L2_Enhanced,L2_SGM,L3_Builder,L1_QT,L3_GNN enhanced
    class Core_Episodes,Core_Index,Core_Graph,DB_Insights dataLayer
    class E1,E2,E3,E4,Exp_Active expLayer