<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>Threshold DFS Live Viewer</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:16px}
    #wrap{display:flex;gap:16px}
    #left{min-width:520px}
    canvas{border:1px solid #e9ecef;background:#fff}
    table{border-collapse:collapse}
    th,td{border:1px solid #e9ecef;padding:4px 6px;font-size:12px}
    th{background:#f8f9fa}
    .muted{opacity:.7}
    .badge{display:inline-block;padding:2px 6px;border-radius:4px;background:#f1f3f5;font-size:12px;margin-left:6px}
  </style>
</head>
<body>
<h2>Threshold DFS Live Viewer <span id="meta" class="badge"></span></h2>
<p class="muted">このビューアは run_summary.js の RUN_DATA を読み込み、迷路と経路、観測ランク（obs_l1_rank）を簡易表示します。</p>

<div id="wrap">
  <div id="left">
    <canvas id="maze" width="512" height="512"></canvas>
    <div style="margin-top:8px">
      <label>Step: <input type="range" id="step" min="1" value="1" /></label>
      <span id="stepLabel"></span>
    </div>
  </div>
  <div id="right">
    <div id="info"></div>
    <h4>Local Observation Ranking (obs_l1_rank)</h4>
    <table id="rank"><thead><tr>
      <th>#</th><th>dir</th><th>dv</th><th>visit</th><th>obs</th><th>id</th>
    </tr></thead><tbody></tbody></table>
  </div>
  
</div>

<script src="run_summary.js"></script>
<script>
(function(){
  const RD = window.RUN_DATA || {};
  const canvas = document.getElementById('maze');
  const ctx = canvas.getContext('2d');
  const stepEl = document.getElementById('step');
  const stepLabel = document.getElementById('stepLabel');
  const info = document.getElementById('info');
  const meta = document.getElementById('meta');
  const rankBody = document.querySelector('#rank tbody');

  const maze = RD.maze || [];
  const W = (maze[0]||[]).length; const H = maze.length;
  const cw = Math.floor(Math.min(512 / Math.max(1,W), 512 / Math.max(1,H)));
  canvas.width = W*cw; canvas.height = H*cw;

  function drawGrid(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(let y=0;y<H;y++){
      for(let x=0;x<W;x++){
        const v = (maze[y][x]===1)?'#222':'#fff';
        ctx.fillStyle = v; ctx.fillRect(x*cw,y*cw,cw,cw);
      }
    }
    ctx.strokeStyle = '#eee';
    ctx.lineWidth = 1;
    for(let y=0;y<=H;y++){ ctx.beginPath(); ctx.moveTo(0,y*cw); ctx.lineTo(W*cw,y*cw); ctx.stroke(); }
    for(let x=0;x<=W;x++){ ctx.beginPath(); ctx.moveTo(x*cw,0); ctx.lineTo(x*cw,H*cw); ctx.stroke(); }
  }

  function drawPath(step){
    const path = RD.path || [];
    if(path.length < 2) return;
    ctx.lineWidth = Math.max(1, Math.floor(cw*0.25));
    // full path in light
    ctx.strokeStyle = '#8ecae6';
    ctx.beginPath();
    for(let i=0;i<Math.min(step,path.length);i++){
      const [x,y]=path[i]; const px=x*cw+cw/2, py=y*cw+cw/2;
      if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
    }
    ctx.stroke();
    // current pos
    const idx=Math.min(step-1, path.length-1);
    const [cx,cy] = path[idx] || [0,0];
    ctx.fillStyle = '#e85d04';
    ctx.beginPath(); ctx.arc(cx*cw+cw/2, cy*cw+cw/2, Math.max(2,cw*0.3), 0, Math.PI*2); ctx.fill();
  }

  function render(step){
    drawGrid();
    drawPath(step);
    stepLabel.textContent = `${step}/${Math.max(1,(RD.path||[]).length)}`;
    // info
    meta.textContent = `${RD.size || ''}×${RD.size || ''} seed=${RD.seed || ''} strategy=${RD.strategy || ''}`
    info.innerHTML = `
      <div>
        <b>Goal:</b> ${RD.goal_reached? '✓':'✗'}
        <span class="badge">steps=${RD.steps}</span>
      </div>`;
    // rank table
    rankBody.innerHTML = '';
    const r = (RD.obs_l1_rank && RD.obs_l1_rank[step-1]) || [];
    r.forEach((it,idx)=>{
      const tr=document.createElement('tr');
      const cells=[idx+1, it.dir, it.dv?.toFixed(3), it.visit, it.obs, it.id];
      cells.forEach(v=>{ const td=document.createElement('td'); td.textContent= v==null? '': String(v); tr.appendChild(td); });
      rankBody.appendChild(tr);
    });
  }

  const total = Math.max(1, (RD.path||[]).length);
  stepEl.max = total; stepEl.value = 1;
  stepEl.addEventListener('input', ()=> render(parseInt(stepEl.value))); 
  render(1);
})();
</script>
</body>
</html>

